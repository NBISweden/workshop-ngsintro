{"title":"Variant Calling Workflow","markdown":{"yaml":{"title":"Variant Calling Workflow","subtitle":"From reads to short variants","description":"On Tetralith at NSC","author":"Malin Larsson","format":"html"},"headingText":"VARIABLES","containsRefs":false,"markdown":"\n\n```{r,eval=TRUE,include=FALSE}\nlibrary(yaml)\nlibrary(here)\nupid <- yaml::read_yaml(here(\"_quarto.yml\"))$uppmax_project\nnscid <- yaml::read_yaml(here(\"_quarto.yml\"))$nsc_project\n```\n\n```{css,include=FALSE}\n.workLocally{\nbackground-color: red;\n}\n```\n\n```{r,include=FALSE}\ndatadir <- \"/sw/courses/ngsintro/reseq/data\"\nfastqdir <- \"/sw/courses/ngsintro/reseq/data/fastq\"\nrefdir <- \"/sw/courses/ngsintro/reseq/data/ref\"\nbamdir <- \"/sw/courses/ngsintro/reseq/data/bam\"\nvcfdir <- \"/sw/courses/ngsintro/reseq/data/vcf\"\nbpbamdir <- \"/sw/courses/ngsintro/reseq/data/best_practise_bam\"\nbpvcfdir <- \"/sw/courses/ngsintro/reseq/data/best_practise_vcf\"\ncol_uppmax <- \"#f4f8e8\"\ncol_local <- \"#e5f4f8\"\n```\n\n# Introduction {-}\n\nWhole genome sequencing (WGS) is a comprehensive method for analyzing entire genomes. This workshop will take you through the process of calling germline short variants (SNVs and INDELs) in WGS data from three human samples. \n  \n1. The first part of the workshop will guide you through a basic variant calling workflow in one sample. The goals are that you should get familiar with the bam and vcf file formats, and learn how to interpret the results of variant calling in Integrative Genomics Viewer (IGV).\n2. If you have time, the next part of the workshop will show you how to perform joint variant calling in three samples. The goals here is that you should be able to interpret multi-sample vcf files and explain the differences between the g.vcf and vcf file formats. Also, if you are interested in programming, another goal is that you should learn to combine individual Linux commands into an SBATCH script.  \n3. If you have time, the last part of the workshop will take you through the GATK best practices for germline short variant detection in three samples. The goal here is that you should learn how to use GATK's documentation so that you can analyze your own samples in the future.    \n\n**General guide**\n\n::: {.callout-note}\n* In this workshop you will work on the computing cluster Tetralith at NSC.\n* You will use a singularity container (a virtual computer) that mimics the UPPMAX environment. \n* In paths, please replace `<nsc_username>` with your NSC username.\n* In commands, please replace `<parameter>` with the correct parameter, for example your input file name, output file name, directory name, etc.\n* Do not copy and paste commands from the exercise to terminal, as this can result in formatting errors. \n* Use tab completion.\n* A line starting with `#` is a comment\n* Running a command without parameters will often return a help message on how to run the command.\n* After a command is completed, please check that the desired output file was generated and that it has a reasonable size (use `ls -l`). \n* A common mistake is to attempt to load input files that do not exist, or create output files where you don't have permission to write.\n* Use output file names that describes what was done in the command.\n* If you change the node you are working on you will need to reload the tool modules. \n* Google errors, someone in the world has run into EXACTLY the same problem you had and asked about it on a forum somewhere.\n:::\n\n# Data description {-}\n## Samples  {-}\n\nThe 1000 Genomes Project ran between 2008 and 2015, creating the largest public catalogue of human variation and genotype data. In this workshop we will use low coverage whole genome sequence data from three individuals, generated in the first phase of the 1000 Genomes Project. \n\nSample        | Population | Sequencing technology\n------------- | ---------- | --------\nHG00097       | British in England and Scotland    | Low coverage WGS\nHG00100       | British in England and Scotland    | Low coverage WGS\nHG00101       | British in England and Scotland    | Low coverage WGS \n\n## Genomic region {#Genomicregion -}  \n\nThe *LCT* gene on chromosome 2 encodes the enzyme lactase, which is responsible for the metabolism of lactose in mammals. Most mammals can not digest lactose as adults, but some humans can. Genetic variants upstream of the *LCT* gene lead to lactase persistence, which means that lactase is expressed also in adulthood and the carrier can continue to digest lactose. The variant rs4988235, located at position chr2:136608646 in the HG19 reference genome, has been shown to lead to lactose persistence. The alternative allele (A on the forward strand and T on the reverse strand) creates a new transcription factor binding site that enables continued expression of the gene after weaning.\n  \nIn this workshop we will use sequencing data for the region chr2:136545000-136617000 \nchr2:136,039,147-136,662,073\nin the 3 samples listed above to illustrate variant calling in NGS data. We will use chromosome 2 from hg19 as reference genome.  \n  \nFor those interested in the details of the genetic bases for lactose tolerance, please read the first three pages of [Lactose intolerance: diagnosis, genetic, and clinical factors](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3401057/pdf/ceg-5-113.pdf) by Mattar et al. The variant rs4988235 is here referred to as LCT-13910C>T.  \n  \n## Data folder on UPPMAX {#Data -}  \n\nAll input data for this exercise is located in this folder:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(datadir))\n```\n\nThe fastq files are located in this folder:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(fastqdir))\n```\n\nReference files, such as the reference genome in fasta format, are located in this folder: \n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(refdir))\n```\n\n# Preparations {-}\n## Local workspace  {#preparelaptop -}  \n\nThe majority of the analyses in this workshop will be done on the computing cluster, but you will copy some of the resulting files to your laptop. Therefore, please start by creating a folder for this workshop on your laptop. It is up to you where you want to put this, but it can for example be a folder called *ngsworkflow* on Desktop. You need to have write permission in this folder. The folder you create here will be referred to as *local workspace* throughout this workshop.  \n  \n## The NSC cluster {-}\n\nPlease connect to the Tetralith cluster at NSC using `ssh`:\n\n```bash\n$ ssh -Y nsc_username@tetralith.nsc.liu.se\n```  \n\n::: {.callout-note}\nNote that your terminal prompt changed to something like `nsc_username@tetralith1 $` which means that you have entered Tetralith. \n:::\n\n### Interactive session {-}\n\nOn Tetralith you enter the *login node*, which is not intended for compute intensive tasks. You should therefore book a compute node, or in this case three cores:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('tetralith1$ interactive -A ',nscid,' -t 04:00:00 -n 3'))\n```\n\n::: {.callout-note}\nYour terminal prompt changed to something like `<nsc_username>@n424 $` (or another node name), which means that you are now running on one of the compute nodes. \n:::\n\n### UPPMAX singularity container {-}\n\nWe will use a singularity container (a virtual computer) that mimics the UPPMAX computing environment. Once you have started the singularity container your environment will look exactly as on UPPMAX, and the software used in this workshop will be available through the module system.\n\nUse this command to start the singularity container:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('n424$ singularity shell -B /proj/',nscid,'/users:/proj/',upid,'/nobackup /proj/',nscid,'/ngsintro.sif'))\n```\n\n::: {.callout-note}\nNote that your terminal prompt changed to something like `<nsc_username>@offline-uppmax$`. This means that you have moved into a \"virtual computer\" that mimics the UPPMAX environment. \n:::\n\nIn the singularity container type this to make modules based on Java to load properly:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('source /uppmax_init'))\n```\n\nTo close the singularity container later on just type `exit` in the terminal, but don't do that now.\n\n### Cluster workspace {-}\n\nWhile running the UPPMAX singularity container, create a workspace folder for this exercise and move into it: \n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('offline-uppmax$ mkdir /proj/',upid,'/nobackup/<nsc_username>/ngsworkflow\\n'))\ncat(paste0('offline-uppmax$ cd /proj/',upid,'/nobackup/<nsc_username>/ngsworkflow'))\n```\n\nThe folder you just created will be referred to as your *cluster workspace* throughout this workshop.  \n\nThe *cluster workspace* can be reached also from outside of the UPPMAX singularity container, in this folder on Tetralith:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('tetralith$ /proj/',nscid,'/users/<nsc_username>/ngsworkflow\\n'))\n```\n\nThis is the path you must use when downloading files to your *local workspace* later on.\n  \n**** \n\n::: {.callout-note}\n**Note:** The rest of the instructions assumes that you are running the UPPMAX singularity container from an interactive session on Tetralith, and that you are located in your *cluster workspace*, unless noted otherwise.\n:::\n\n### Symbolic links to data {-}\n\nThe raw data files are located in the [Data](#Data) folder described above. Instead of copying the files to your workspace you should create symbolic links (soft-links) to them. Soft-linking files and folders allows you to work with them as if they were in your current directory, but without multiplying them.  \n\nCreate a symbolic link to the reference genome in your workspace:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('offline-uppmax$ ln -s ',refdir,'/human_g1k_v37_chr2.fasta'))\n```\n\nDo the same with the fastq files:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00097_1.fq\\n')) \ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00097_2.fq\\n'))  \ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00100_1.fq\\n'))\ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00100_2.fq\\n'))\ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00101_1.fq\\n')) \ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00101_2.fq\\n'))\n```\n\n### Accessing programs {#Accessingprograms -}\n\nWe will use several programs that are installed in the module system on UPPMAX. These modules must be loaded *every time* you start the singularity container.\n  \nFirst load the `bioinfo-tools` module:\n\n```bash\noffline-uppmax$ module load bioinfo-tools\n```\nThis makes it possible to load the individual programs:\n\n```bash\noffline-uppmax$ module load FastQC/0.11.8\noffline-uppmax$ module load bwa/0.7.17\noffline-uppmax$ module load samtools/1.10\noffline-uppmax$ module load GATK/4.1.4.1\n```\n\n::: {.callout-note}\nYou don't have to specify which versions of the tools to use, but is recommended to do so for reproducibility if you want to rerun the  exact same analyses later.\n:::\n\nWhen loading the module GATK/4.1.4.1 you may get a warning message about the fact that GATK commands have been updated since the previous version of GATK. This is fine and you don't have to do anything about it. \n    \n## Index the genome {-}\n\nTools that compare short reads with a large reference genome needs indexes of the reference genome to work efficiently. You therefore need to create index files for each tool. \n  \nGenerate BWA index files:\n\n```bash\noffline-uppmax$ bwa index -a bwtsw human_g1k_v37_chr2.fasta\n```\n\nCheck to see that several new files have been created using `ls -l`.\n  \nGenerate a samtools index: \n\n```bash\noffline-uppmax$ samtools faidx human_g1k_v37_chr2.fasta\n```\n\nCheck to see what file(s) were created using `ls -lrt`.\n\nGenerate a GATK sequence dictionary:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g CreateSequenceDictionary -R human_g1k_v37_chr2.fasta -O human_g1k_v37_chr2.dict\n```\n\nAgain, check what file(s) were created using `ls -lrt`. \n\n# Variant calling in one sample\n\nNow let's start the main part of the workshop, which will guide you through a basic variant calling workflow in one sample. The workflow consists of aligning the reads with [BWA](http://bio-bwa.sourceforge.net) and detecting variants with [HaplotypeCaller](https://gatk.broadinstitute.org/hc/en-us/articles/360037225632-HaplotypeCaller) as illustrated below. \n  \n![](assets/1_onesamplevc.png)\n\n## Aligning reads\n\n### BWA mem {#bwamem}\n\nIn the *Cluster workspace* you should now use `BWA mem` to align the reads to the reference genome.  \n \nAt the same time, you should add something called *read groups* to the reads in the fastq files. Read groups allow us to trace various technical features, such as which flow cell was used to generate the reads, and this is needed in order to perform variant calling with HaplotypeCaller. You are not expected to learn all the details of read groups here, but if you are interested in more information please read this article at [GATK-forum](https://gatk.broadinstitute.org/hc/en-us/articles/360035890671-Read-groups). The samples in this workshop come from the 1000 Genomes project, and we don't know how these reads were generated. Let's assume that each fastq file was generated from one library preparation (called *libraryx*), derived from one biological sample (called *HG00097*), that was run on one lane of a flow cell (called *lanex_flowcellx*) in the Illumina machine, and create a read group with id *readgroupx* that contains this information.   \n  \nThe output from `BWA` should be parsed to `samtools sort`, which sorts the sam file according to chromosome position and then converts the sam file to the binary bam format. This saves space since no intermediary sam file is created.  \n\nPlease use this command for all of this:\n\n```bash\noffline-uppmax$ bwa mem -R \"@RG\\\\tID:readgroupx\\\\tPU:lanex_flowcellx\\\\tSM:HG00097\\\\tLB:libraryx\\\\tPL:illumina\" -t 1 human_g1k_v37_chr2.fasta HG00097_1.fq HG00097_2.fq | samtools sort > HG00097.bam\n```\n\nWhere `-t 1` is the number of threads, which should be equal to the number of cores you booked. If you would have analysed the entire genome more threads would have been necessary.  \n\nYou have to use a file redirect `>` for the output, otherwise it will be written to stdout (your screen).  \n\nPlease check that the expected output file was generated and that it has content using `ls -lrt`. \n\nNext you need to index the output bam file so that programs can randomly access the sorted data without reading the whole file. This command creates an index file with the same name as the input bam file, except with a .bai extension:  \n\n```bash\noffline-uppmax$ samtools index HG00097.bam\n```\n\nPlease check what output file was generated this time. \n  \n### Check bam with samtools\n\nThe bam file is binary so we cannot read it, but we can view it with `samtools view`. The header section of the bam file can be viewed separately with the `-H` flag:\n\n```bash\noffline-uppmax$ samtools view -H HG00097.bam \n```\n\nTo look at the reads in the bam file just use `samtools view` without the `-H`. This will display the entire bam file which is quite large, so if you just want to look at the first 5 lines (for example) you can combine `samtools view` with `head`:\n\n```bash\noffline-uppmax$ samtools view HG00097.bam | head -n 5 \n```\n\nFor help with interpreting the bam file, please look at the sam/bam format definition at [Sequence Alignment/Map Format Specification](https://samtools.github.io/hts-specs/SAMv1.pdf).  \n  \n### Questions  \n\n1. What does \"SO:coordinate\" in the \"@HD\" tag on the first line of the bam file mean?    \n2. What does \"SN:2\" and \"LN:243199373\" in the \"@SQ tag mean? \n3. What is encoded in the @RG tag?  \n4. What is the leftmost mapping position of the first read in the bamfile? \n  \n### Check bam in IGV\n\n**Install IGV**  \n\nIntegrated Genomics Viewer (IGV) provides an interactive visualisation of the reads in a bam file. Here we will show you how to run IGV on your laptop. If you have not used IGV on your laptop before, then go to the IGV [download page](https://software.broadinstitute.org/software/igv/download), and follow the instructions to download it. It will prompt you to fill in some information and agree to license. Launch the viewer through web start. The 1.2 Gb version should be sufficient for our data.\n  \n**Download the bam file** \n\nOpen a new terminal window on your laptop and navigate to your [local workspace](#preparelaptop), **but do not log in to NSC**. Download the .bam and .bam.bai files you just generated with this command:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('scp <nsc_username>@tetralith.nsc.uu.se:/proj/',nscid,'/users/<nsc_username>/ngsworkflow/HG00097.bam* .'))\n```\n\nCheck that the files are now present in your *local workspace* using `ls -lrt`. \n  \n**Look at the bam file in IGV**  \n\n- In `IGV`, go to the popup menu in the upper left and set it to `Human hg19`.  \n- In the `Tools` menu, select `Run igvtools`. Choose the command `Count` and then use the `Browse` button next to the `Input File` line to select the bam file (not the bai) that you just downloaded. It will autofill the output file. Hit the `Run` button. This generates a .tdf file that allows you to see the coverage value for our bam file even at zoomed out views. `Close` the igvtools window.  \n- In the `File` menu, select `Load from File` and select your BAMs (not the .bai or the .tdf), which should appear in the tracks window. You will have to zoom in before you can see any reads. You can either select a region by click and drag, or by typing a region or a gene name in the text box at the top. Remember that we have data for the region chr2:136545000-136617000.\n  \n### Questions  \n\n5. What is the read length?  \n6. How can you estimate the coverage at a specific position in IGV? \n7. Which RefSeq Genes are located within the region chr2:136545000-136617000?\n  \n## Variant Calling\n\n### HaplotypeCaller {#haplotypecaller}\n\nNow we will detect short variants in the bam file using GATK's `HaplotypeCaller`. Go to your *Cluster workspace* and run:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -I HG00097.bam -O HG00097.vcf \n```\n\nCheck what new files were generated with `ls -lrt`.  \n  \n### Explore the vcf file\n\nNow you have your first vcf file containing the raw variants in the region chr2:136545000-136617000 in sample HG00097. Please look at the vcf file with `less` and try to understand its structure.  \n  \nVCF files contains meta-information lines starting with *##*, a header line starting with *#CHROM*, and then data lines each containing information about one variant position in the genome. The header line defines the columns of the data lines, and to view the header line you can type this command:  \n\n```bash\noffline-uppmax$ grep '#CHROM' HG00097.vcf\n```\n\nThe meta-information lines starting with *##INFO* defines how the data in the *INFO* column is encoded, and the meta-information lines starting with *##FORMAT* defines how the data in the *FORMAT* column is encoded. To view the meta-information lines describing the *INFO* column use:\n\n```bash\noffline-uppmax$ grep '##INFO' HG00097.vcf\n```\n\nTo view the meta-information lines describing the *FORMAT* column use: \n\n```bash\noffline-uppmax$ grep '##FORMAT' HG00097.vcf\n```\n\nNow lets look at the details of one specific genetic variant at position 2:136545844:\n\n```bash\noffline-uppmax$ grep '136545844' HG00097.vcf\n```\n\nFor more detailed information about vcf files please have a look at [The Variant Call Format specification](https://samtools.github.io/hts-specs/VCFv4.2.pdf).\n  \n### Questions\n\n8. What column of the VCF file contains genotype information for the sample HG00097?\n9. What does *GT* in the *FORMAT* column of the data lines mean?\n10. What genotype does the sample HG00097 have at position 2:136545844?\n11. What does *AD* in the *FORMAT* column of the data lines mean? \n12. What are the allelic depths for the reference and alternative alles in sample HG00097 at position 2:136545844?\n13. How many genetic variants was detected in the sample? The linux command `grep -v \"#\" HG00097.vcf | wc -l ` extracts all lines in HG00097.vcf that *don't* start with \"#\", and counts these lines.  \n\n### Check vcf in IGV {#vcfinigv}\n\nDownload the vcf file and its index to the *local workspace* on your laptop, just like you did with the bam file and its index earlier. Open a new terminal window on your laptop and navigate to your local workspace, **but do not log in to NSC**. Download the files that you just generated with:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\", class.source=\"workLocally\"}\ncat(paste0('scp <nsc_username>@tetralith.nsc.uu.se:/proj/',nscid,'/users/<nsc_username>/ngsworkflow/HG00097.vcf* .'))\n```\n\nPlease replace `<nsc_nsc_username>` with your NSC user name.  \nNote that the * in the end of the file name means that you will download all files that start with *HG00097.vcf*, so you will also download the vcf index.  \nCheck that the files were properly downloaded to your *local workspace* using `ls -lrt`. \n\nIn `IGV`, in the `File` menu, select `Load from File` and select your vcf file (not the .idx file) and the bam file (not the .bai file) that you downloaded earlier. The vcf and bam files should appear in the tracks window. You will now see all the variants called in HG00097. You can view all variants in the *LCT* gene by typing the gene name in the search box, and you can look specifically at the variant at position chr2:136545844 by typing that position in the search box.  \n  \n### Questions  \n\n14. Hover the mouse over the upper row of the vcf track. What is the reference and alternative alleles of the variant at position chr2:136545844? \n15. Hover the mouse over the lower row of the vcf track and look under \"Genotype Information\". What genotype does HG00097 have at position chr2:136545844? Is this the same as you found by looking directly in the vcf file in question 10?\n16. Look in the bam track and count the number of reads that have \"T\" and \"C\", respectively,  at position chr2:136545844. How is this information captured under \"Genotype Attributes\"? (Again, hoover the mouse over the lower row of the vcf track.)\n \n# Variant calling in cohort {#jointvc}\n\nIf you have time, you can now try joint variant calling in all three samples. Each sample has to be processed with `BWA mem` as above, and then with `HaplotypeCaller` with the flag `-ERC` to generate one g.vcf file per sample. The individual g.vcf files should subsequently be combined with GATK's `CombineGVCFs`, and translated into vcf format with GATK's `GenotypeGVCFs`. The workflow below shows how the three samples should be processed and combined.  \n  \n![](assets/2_jointvc.png)\n\n\nYou can run the commands one by one in the terminal as you did before. We have also made intermediary files available in case you don't have time to complete all steps, please see links under each analysis step. \n\n::: {.callout-note}\n**Optional**: If you are interested in programming and have time, you can also try to write a simple SBATCH script and run all steps automatically. Please check out the [SBATCH script](#sbatchscript) section below if you would like to try this.\n:::\n\n## BWA mem \n\nRun `BWA mem` for all three samples in the data set. `BWA mem` should be run exactly [as above](#bwamem) but with the new sample names. Please note that you also need to adjust the SM field in the read group so that it matches the new sample name, otherwise the [joint genotyping step](#jointgenotyping) will not work properly.  \n  \nIf you run out of time, please click below to get paths to precomputed bam files. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0(bamdir,'/HG00097.bam\\n')) \ncat(paste0(bamdir,'/HG00100.bam\\n')) \ncat(paste0(bamdir,'/HG00101.bam\\n')) \n```\n \n## Generate g.vcf files {#generategvcf}\n\n`HaplotypeCaller` should also be run for all three samples, but this time the output for each sample needs to be in g.vcf format. This is accomplished with a small change in the `HaploteypCaller` command: \n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -ERC GVCF -I <sample.bam> -O <sample>.g.vcf \n```\n\nPlease replace <sample> with the real sample names.\n   \nIf you run out of time, please click below to get paths to the precomputed g.vcf files.\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0(vcfdir,'/HG00097.g.vcf\\n')) \ncat(paste0(vcfdir,'/HG00100.g.vcf\\n')) \ncat(paste0(vcfdir,'/HG00101.g.vcf\\n')) \n```\n  \n## Joint genotyping {#jointgenotyping}\n\nOnce you have the g.vcf files for all samples you should perform joint genotype calling. To do this you first need to combine all individual .g.vcf files to one file using `CombineGVCFs`:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g CombineGVCFs -R human_g1k_v37_chr2.fasta -V <sample1>.g.vcf -V <sample2>.g.vcf -V <sample3>.g.vcf -O cohort.g.vcf\n```\n\nPlease replace `<sample1>`, `<sample2>`, `<sample3>` with the real sample names.\n  \nThen run GATK's `GenoteypeGVC` to generate a vcf file:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g GenotypeGVCFs -R human_g1k_v37_chr2.fasta -V cohort.g.vcf -O cohort.vcf\n```\n\nIf you run out of time, please click below to get paths to the precomputed cohort.g.vcf and cohort.vcf files.\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0(vcfdir,'/cohort.g.vcf\\n')) \ncat(paste0(vcfdir,'/cohort.vcf\\n')) \n```\n\n### Questions {#jointvariantcallingquestions}\n\n17. How many data lines do the cohort.g.vcf file have? You can use the Linux command `grep -v \"#\" cohort.g.vcf` to extract all lines in \"cohort.g.vcf\" that don't start with \"#\", then `|`, and then `wc -l` to count those lines.  \n18. How many data lines do the cohort.vcf file have?  \n19. Explain the difference in number of data lines.  \n20. Look at the header line of the cohort.vcf file. What columns does it have? \n21. What is encoded in the last three columns of the data lines?\n  \n## SBATCH script {#sbatchscript}\n\n::: {.callout-note}\n\n## Optional\n\nThis section is only for those of you who want to try to run all steps automatically in bash scripts. \nBelow is a skeleton script that can be used as a template. Please modify it to run all the steps in part two of this workshop. You might find it helpful to try each step for one sample in the interactive terminal, so that you know that a particular command is working, before you incorporate it in the script.  \n\n```bash\n#!/bin/bash\nmodule load bioinfo-tools\nmodule load bwa/0.7.17\nmodule load samtools/1.10\nmodule load GATK/4.1.4.1\n## loop through the samples:\nfor sample in HG00097 HG00100 HG00101;\ndo\n  echo \"Now analyzing: \"$sample\n  #Fill in the code for running bwa-mem for each sample here\n  #Fill in the code for samtools index for each sample here \n  #Fill in the code for HaplotypeCaller for each sample here\ndone\n#Fill in the code for CombineGVCFs for all samples here\n#Fill in the code for GenotypeGVCFs here\n```\n\nPlease save the sbatch script in your cluster folder and call it \"joint_genotyping.sh\" or similar. Make the script executable by this command:\n\n```bash\nchmod u+x joint_genotyping.sh\n```\n\nUse this command to run the script in the singularity container:\n\n```bash\n./joint_genotyping.sh\n```\n\nIf you would like more help with creating the bash script, please look at our example solution:\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('#!/bin/bash\n\nmodule load bioinfo-tools\nmodule load bwa/0.7.17\nmodule load samtools/1.10\nmodule load GATK/4.1.4.1\n\nfor sample in HG00097 HG00100 HG00101;\ndo\n  echo \"Now analyzing: \"$sample\n  bwa mem -R \"@RG\\\\tID:readgroupx\\\\tPU:flowcellx_lanex\\\\tSM:\"$sample\"\\\\tLB:libraryx\\\\tPL:illumina\" -t 1 human_g1k_v37_chr2.fasta $sample\"_1.fq\" $sample\"_2.fq\" | samtools sort > $sample\".bam\"\n  samtools index $sample\".bam\"\n  gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -ERC GVCF -I $sample\".bam\" -O $sample\".g.vcf\"\ndone\ngatk --java-options -Xmx7g CombineGVCFs -R human_g1k_v37_chr2.fasta -V HG00097.g.vcf -V HG00100.g.vcf -V HG00101.g.vcf -O cohort.g.vcf\ngatk --java-options -Xmx7g GenotypeGVCFs -R human_g1k_v37_chr2.fasta -V cohort.g.vcf -O cohort.vcf'\n))\n```  \n\nPlease answer the [questions ](#jointvariantcallingquestions) above.\n\n:::\n\n## Check combined vcf file in IGV\n\nDownload the file cohort.vcf and its index, as well as HG00100.bam and HG00101.bam and their indexes to your *local workspace* as described [above]{#downloaddata}. Then open cohort.vcf, HG00097.bam, HG00100.bam and HG00101.bam in IGV as described [above]{#vcfinigv}. This time lets look at the variant rs4988235, located at position chr2:136608646 in the HG19 reference genome, that has been shown to lead to lactose persistence. \n  \n### Questions\n\n22. What is the reference and alternative alleles at chr2:136608646?\n23. What genotype do the three samples have at chr2:136608646? Note how genotypes are color coded in IGV.\n24. Should any of the individuals avoid drinking milk?   \n25. Now compare the data shown in IGV with the data in the VCF file. Extract the row for the chr2:136608646 variant in the cohort.vcf file, for example using `grep '136608646' cohort.vcf`. What columns of the vcf file contain the information shown in the upper part of the vcf track in IGV?\n26. What columns of the vcf file contain the information shown in the lower part of the vcf track?\n27. Zoom out so that you can see the *MCM6* and *LCT* genes. Is the variant at chr2:136608646 locate within the LCT gene?  \nIf you are interested in how this variant affects lactose tolerance please read the article by Mattar et al presented [above](#Genomicregion), or in [OMIM](https://www.omim.org/entry/601806#0001).\n\n# GATK's best practices\n\nThe third part of this workshop will take you through additional refinement steps that are recommended in [GATKs best practices for germline short variant discovery](https://gatk.broadinstitute.org/hc/en-us/articles/360035535932-Germline-short-variant-discovery-SNPs-Indels-), illustrated in the flowchart below. You can either run the steps command by command in your reserved node, or using a similar script as described above. \n\n![](assets/3_best_practise.png){width=80%}\n  \n## BWA mem \n\nRun `BWA mem` for all three samples in the data set. `BWA mem` should be run exactly [as above](#bwamem) but with the new sample names. Please note that you also need to adjust the SM field in the read group so that it matches the new sample name. \n  \n## Mark Duplicates\n\nSometimes the same DNA fragment is sequenced multiple times, which leads to multiple reads from the same fragment in the fastq file. This can occur due to PCR amplification in the library preparation, or if one read cluster is incorrectly detected as multiple clusters by the sequencing instrument. \nIf a duplicated read contains a genetic variant, the ratio of the two alleles might be obscured, which can lead to incorrect genotyping. It is therefore recommended (in most cases) to mark duplicate reads so that they are counted as one during genotyping. \n  \nPlease read about Picard's `MarkDuplicates` [here](https://gatk.broadinstitute.org/hc/en-us/articles/360037225972-MarkDuplicates-Picard-). Picard's MarkDuplicates has recently been incorporated into the GATK suite, but the usage example in GATKs documentation still describes how to call it via the stand alone Picard program. A usage example for the version of MarkDuplicates that is incorporated in GATK is (with this you don't have to load the Picard module): \n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g MarkDuplicates \\\n      -I input.bam \\\n      -O marked_duplicates.bam \\\n      -M marked_dup_metrics.txt\n```\n\nIf you would like more help you can sneak peek at our example solution for HG00097 below. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g MarkDuplicates -I HG00097.bam -O HG00097.md.bam -M HG00097_mdmetrics.txt'))\n```\n  \n## Recalibrate Base Quality Scores\n\nAnother source of error is systematic biases in the assignment of base quality scores by the sequencing instrument. This can be corrected by GATK's [Base Quality Score Recalibration](https://gatk.broadinstitute.org/hc/en-us/articles/360035890531-Base-Quality-Score-Recalibration-BQSR-). \nIn short, you first use [BaseRecalibrator](https://gatk.broadinstitute.org/hc/en-us/articles/360037593511-BaseRecalibrator) to build a recalibration model, and then [ApplyBQSR](https://gatk.broadinstitute.org/hc/en-us/articles/360037225212-ApplyBQSR) to recalibrate the base qualities in your bam file.  \n`BaseRecalibrator` requires a file with known SNPs as input. This file is available in the data folder on UPPMAX:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(refdir,'/1000G_phase1.snps.high_confidence.b37.chr2.vcf'))\n```\n\nPlease use GATK's documentation to recalibrate the base quality scores in your data. If you would like more help you can sneak peek at our example solution for HG00097 below. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g BaseRecalibrator -R human_g1k_v37_chr2.fasta -I HG00097.md.bam> --known-sites ',refdir,'/1000G_phase1.snps.high_confidence.b37.chr2.vcf -O HG00097.recal.table\\n'))\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g ApplyBQSR -R human_g1k_v37_chr2.fasta -I HG00097.md.bam --bqsr-recal-file HG00097.recal.table -O HG00097.recal.bam'))\n```\n\n## Generate g.vcf files\n\n`HaplotypeCaller` should also be run for all three samples, and the output should be in g.vcf exactly as described [above](#generategvcf). This time use recalibrated bam files as input. \n\n## Joint genotyping\n\nOnce you have the g.vcf files for all samples you should perform joint genotype calling. This should be done with the commands `CombineGVCFs` and `GenotypeGVCFs` exactly as described  [above](#jointgenotyping), but you should use the g.vcf files generated from the recalibrated bam files as input.\n\n## Variant Filtering\n\nHaplotypeCaller is designed to be very sensitive, which is good because it minimises the chance of missing real variants. However, it means that the number of false positives can be quite large, so we need to filter the raw callset. GATK offers two ways to filter variants:  \n\n1. The variant quality score recalibration (VQSR) method uses machine learning to identify variants that are likely to be real. This is the best method if you have a lot of data, for example one whole genome sequence sample or several whole exome samples. \n2. If you have less data you can use hard filters as described [here](https://gatk.broadinstitute.org/hc/en-us/articles/360035531112?id=2806#2). \n  \nSince we have very little data we will use hard filters. The parameters are slightly different for SNVs and INDELs, so you need to first select all SNVs using [SelectVariants](https://gatk.broadinstitute.org/hc/en-us/articles/360037225432-SelectVariants) and filter them using [VariantFiltration](https://gatk.broadinstitute.org/hc/en-us/articles/360037226192-VariantFiltration) with the parameters suggested for SNVs. Then select all INDELs and filter them with the parameters suggested for INDELs. Finally merge the SNVs and INDELs to get all variants in one file using [MergeVCFs](https://gatk.broadinstitute.org/hc/en-us/articles/360037226612-MergeVcfs-Picard-). If you would like more help you can sneak peek at our example solution for HG00097 below.  \n\nFilter SNVs:\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g SelectVariants \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.vcf \\\n  --select-type-to-include SNP \\\n  -O cohort.snvs.vcf\n  \noffline-uppmax$ gatk --java-options -Xmx7g VariantFiltration \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.snvs.vcf \\\n  -O cohort.snvs.filtered.vcf \\\n  --filter-name QDfilter --filter-expression \"QD < 2.0\"  \\\n  --filter-name MQfilter --filter-expression \"MQ < 40.0\"  \\\n  --filter-name FSfilter --filter-expression \"FS > 60.0\"'))\n```\n\nFilter INDELs: \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g SelectVariants \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.vcf \\\n  --select-type-to-include INDEL \\\n  -o cohort.indels.vcf\n\noffline-uppmax$ gatk --java-options -Xmx7g VariantFiltration \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.indels.vcf \\\n  -O cohort.indels.filtered.vcf \\\n  --filter-name QDfilter --filter-expression \"QD < 2.0\" \\\n  --filter-name FSfilter --filter-expression \"FS > 200.0\"'))\n```\n\nMerge filtered SNVs and INDELs: \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g MergeVcfs -I cohort.snvs.filtered.vcf -I cohort.indels.filtered.vcf -O cohort.filtered.vcf'))\n```\n  \nOpen your filtered vcf with `less` and page through it. It still has all the variant lines, but the FILTER column that was blank before is now filled in, with PASS or a list of the filters it failed. Note also that the filters that were run are described in the header section.\n\n## Precomputed files\n\nIf you run out of time, please click below to get the path to precomputed bam and vcf files for the GATK's best practices section.\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('Path to intermediary and final bam files: ',bpbamdir,'\\n'))\ncat(paste0('Path to intermediary and final vcf files: ',bpvcfdir,'\\n'))\n```\n\n## SBATCH script {#bpscript}\n\nWe recommend you to incorporate the new steps into an SBATCH script similar to the one you created above for [joint variant calling](#sbatchscript). Please try to complete the script for GATK's best practices workflow. If you run out of time you can sneak peek at our example solution below. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('#!/bin/bash\n\n## load modules\nmodule load bioinfo-tools\nmodule load bwa/0.7.17\nmodule load samtools/1.10\nmodule load GATK/4.1.4.1\n\n# define path to reference genome\nref=\"/sw/courses/ngsintro/reseq/data/ref\"\n\n# make symbolic links\nln -s /sw/courses/ngsintro/reseq/data/ref/human_g1k_v37_chr2.fasta\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00097_1.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00097_2.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00100_1.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00100_2.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00101_1.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00101_2.fq\n\n# index reference genome\nbwa index -a bwtsw human_g1k_v37_chr2.fasta\nsamtools faidx human_g1k_v37_chr2.fasta\ngatk --java-options -Xmx7g CreateSequenceDictionary -R human_g1k_v37_chr2.fasta -O human_g1k_v37_chr2.dict\n\n## loop through the samples:\nfor sample in HG00097 HG00100 HG00101;\ndo\n  echo \"Now analyzing: ${sample}\"\n  # map the reads\n  bwa mem -R \"@RG\\\\tID:readgroupx\\\\tPU:flowcellx_lanex\\\\tSM:\"$sample\"\\\\tLB:libraryx\\\\tPL:illumina\" -t 1 human_g1k_v37_chr2.fasta $sample\"_1.fq\" $sample\"_2.fq\" | samtools sort > $sample\".bam\"\n  samtools index $sample\".bam\"\n  # mark duplicates\n  gatk --java-options -Xmx7g MarkDuplicates -I $sample\".bam\" -O $sample\".md.bam\" -M $sample\"_mdmetrics.txt\"\n  # base quality score recalibration\n  gatk --java-options -Xmx7g BaseRecalibrator -R human_g1k_v37_chr2.fasta -I $sample\".md.bam\" --known-sites $ref\"/1000G_phase1.snps.high_confidence.b37.chr2.vcf\" -O $sample\".recal.table\"\n  gatk --java-options -Xmx7g ApplyBQSR -R human_g1k_v37_chr2.fasta -I $sample\".md.bam\" --bqsr-recal-file $sample\".recal.table\" -O $sample\".recal.bam\"\n  # haplotypeCaller in -ERC mode\n  gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -ERC GVCF -I $sample\".bam\" -O $sample\".g.vcf\" \ndone\n\n# joint genotyping\ngatk --java-options -Xmx7g CombineGVCFs -R human_g1k_v37_chr2.fasta -V HG00097.g.vcf -V HG00100.g.vcf -V HG00101.g.vcf -O cohort.g.vcf\ngatk --java-options -Xmx7g GenotypeGVCFs -R human_g1k_v37_chr2.fasta -V cohort.g.vcf -O cohort.vcf\n# variant filtration SNPs\ngatk --java-options -Xmx7g SelectVariants -R human_g1k_v37_chr2.fasta -V cohort.vcf --select-type-to-include SNP -O cohort.snvs.vcf\ngatk --java-options -Xmx7g VariantFiltration -R human_g1k_v37_chr2.fasta -V cohort.snvs.vcf -O cohort.snvs.filtered.vcf --filter-name QDfilter --filter-expression \"QD < 2.0\" --filter-name MQfilter --filter-expression \"MQ < 40.0\"  --filter-name FSfilter --filter-expression \"FS > 60.0\"\n# variant filtration indels\ngatk --java-options -Xmx7g SelectVariants -R human_g1k_v37_chr2.fasta -V cohort.vcf --select-type-to-include INDEL -O cohort.indels.vcf\ngatk --java-options -Xmx7g VariantFiltration -R human_g1k_v37_chr2.fasta -V cohort.indels.vcf -O cohort.indels.filtered.vcf --filter-name QDfilter --filter-expression \"QD < 2.0\" --filter-name FSfilter --filter-expression \"FS > 200.0\"\n# merge filtered SNPs and indels\ngatk --java-options -Xmx7g MergeVcfs -I cohort.snvs.filtered.vcf -I cohort.indels.filtered.vcf -O cohort.filtered.vcf'\n))\n```  \n  \n## Questions  \n\n28. How many variants are present in the cohort.filtered.vcf file?  \n29. How many variants have passed the filters?  \n30. Look at the variants that did not pass the filters using `grep -v 'PASS' cohort.filtered.vcf`. Try to understand why these variants didn't pass the filter.\n\n# Clean up {-}\n\nWhen the analysis is done and you are sure that you have the desired output, it is a good practice to remove intermediary files that are no longer needed. This will save disk space, and will be a crucial part of the routines when you work with your own data. Please think about which files you need to keep if you would like to go back and look at this lab later on. Remove the other files.\n  \n# Answers {-}\n\nWhen you have finished the exercise, please have a look at this document with [answers to all questions](lab_vc_answers.pdf), and compare them with your answers. \n\n# Additional information {-}\n\n* Here is a technical documentation of [Illumina Quality Scores](https://www.illumina.com/documents/products/technotes/technote_understanding_quality_scores.pdf)\n* Tools used or referenced \n  * [BWA](http://bio-bwa.sourceforge.net/bwa.shtml)\n  * [FastQC](https://www.bioinformatics.babraham.ac.uk/projects/fastqc/)\n  * [MultiQC](http://multiqc.info/)\n  * [Picard](https://broadinstitute.github.io/picard/command-line-overview.html)\n  * [GATK](https://software.broadinstitute.org/gatk/)\n  * [samtools](http://www.htslib.org/)\n\n**Thanks for today!**\n","srcMarkdownNoYaml":"\n\n```{r,eval=TRUE,include=FALSE}\nlibrary(yaml)\nlibrary(here)\nupid <- yaml::read_yaml(here(\"_quarto.yml\"))$uppmax_project\nnscid <- yaml::read_yaml(here(\"_quarto.yml\"))$nsc_project\n```\n\n```{css,include=FALSE}\n.workLocally{\nbackground-color: red;\n}\n```\n\n```{r,include=FALSE}\n## VARIABLES\ndatadir <- \"/sw/courses/ngsintro/reseq/data\"\nfastqdir <- \"/sw/courses/ngsintro/reseq/data/fastq\"\nrefdir <- \"/sw/courses/ngsintro/reseq/data/ref\"\nbamdir <- \"/sw/courses/ngsintro/reseq/data/bam\"\nvcfdir <- \"/sw/courses/ngsintro/reseq/data/vcf\"\nbpbamdir <- \"/sw/courses/ngsintro/reseq/data/best_practise_bam\"\nbpvcfdir <- \"/sw/courses/ngsintro/reseq/data/best_practise_vcf\"\ncol_uppmax <- \"#f4f8e8\"\ncol_local <- \"#e5f4f8\"\n```\n\n# Introduction {-}\n\nWhole genome sequencing (WGS) is a comprehensive method for analyzing entire genomes. This workshop will take you through the process of calling germline short variants (SNVs and INDELs) in WGS data from three human samples. \n  \n1. The first part of the workshop will guide you through a basic variant calling workflow in one sample. The goals are that you should get familiar with the bam and vcf file formats, and learn how to interpret the results of variant calling in Integrative Genomics Viewer (IGV).\n2. If you have time, the next part of the workshop will show you how to perform joint variant calling in three samples. The goals here is that you should be able to interpret multi-sample vcf files and explain the differences between the g.vcf and vcf file formats. Also, if you are interested in programming, another goal is that you should learn to combine individual Linux commands into an SBATCH script.  \n3. If you have time, the last part of the workshop will take you through the GATK best practices for germline short variant detection in three samples. The goal here is that you should learn how to use GATK's documentation so that you can analyze your own samples in the future.    \n\n**General guide**\n\n::: {.callout-note}\n* In this workshop you will work on the computing cluster Tetralith at NSC.\n* You will use a singularity container (a virtual computer) that mimics the UPPMAX environment. \n* In paths, please replace `<nsc_username>` with your NSC username.\n* In commands, please replace `<parameter>` with the correct parameter, for example your input file name, output file name, directory name, etc.\n* Do not copy and paste commands from the exercise to terminal, as this can result in formatting errors. \n* Use tab completion.\n* A line starting with `#` is a comment\n* Running a command without parameters will often return a help message on how to run the command.\n* After a command is completed, please check that the desired output file was generated and that it has a reasonable size (use `ls -l`). \n* A common mistake is to attempt to load input files that do not exist, or create output files where you don't have permission to write.\n* Use output file names that describes what was done in the command.\n* If you change the node you are working on you will need to reload the tool modules. \n* Google errors, someone in the world has run into EXACTLY the same problem you had and asked about it on a forum somewhere.\n:::\n\n# Data description {-}\n## Samples  {-}\n\nThe 1000 Genomes Project ran between 2008 and 2015, creating the largest public catalogue of human variation and genotype data. In this workshop we will use low coverage whole genome sequence data from three individuals, generated in the first phase of the 1000 Genomes Project. \n\nSample        | Population | Sequencing technology\n------------- | ---------- | --------\nHG00097       | British in England and Scotland    | Low coverage WGS\nHG00100       | British in England and Scotland    | Low coverage WGS\nHG00101       | British in England and Scotland    | Low coverage WGS \n\n## Genomic region {#Genomicregion -}  \n\nThe *LCT* gene on chromosome 2 encodes the enzyme lactase, which is responsible for the metabolism of lactose in mammals. Most mammals can not digest lactose as adults, but some humans can. Genetic variants upstream of the *LCT* gene lead to lactase persistence, which means that lactase is expressed also in adulthood and the carrier can continue to digest lactose. The variant rs4988235, located at position chr2:136608646 in the HG19 reference genome, has been shown to lead to lactose persistence. The alternative allele (A on the forward strand and T on the reverse strand) creates a new transcription factor binding site that enables continued expression of the gene after weaning.\n  \nIn this workshop we will use sequencing data for the region chr2:136545000-136617000 \nchr2:136,039,147-136,662,073\nin the 3 samples listed above to illustrate variant calling in NGS data. We will use chromosome 2 from hg19 as reference genome.  \n  \nFor those interested in the details of the genetic bases for lactose tolerance, please read the first three pages of [Lactose intolerance: diagnosis, genetic, and clinical factors](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3401057/pdf/ceg-5-113.pdf) by Mattar et al. The variant rs4988235 is here referred to as LCT-13910C>T.  \n  \n## Data folder on UPPMAX {#Data -}  \n\nAll input data for this exercise is located in this folder:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(datadir))\n```\n\nThe fastq files are located in this folder:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(fastqdir))\n```\n\nReference files, such as the reference genome in fasta format, are located in this folder: \n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(refdir))\n```\n\n# Preparations {-}\n## Local workspace  {#preparelaptop -}  \n\nThe majority of the analyses in this workshop will be done on the computing cluster, but you will copy some of the resulting files to your laptop. Therefore, please start by creating a folder for this workshop on your laptop. It is up to you where you want to put this, but it can for example be a folder called *ngsworkflow* on Desktop. You need to have write permission in this folder. The folder you create here will be referred to as *local workspace* throughout this workshop.  \n  \n## The NSC cluster {-}\n\nPlease connect to the Tetralith cluster at NSC using `ssh`:\n\n```bash\n$ ssh -Y nsc_username@tetralith.nsc.liu.se\n```  \n\n::: {.callout-note}\nNote that your terminal prompt changed to something like `nsc_username@tetralith1 $` which means that you have entered Tetralith. \n:::\n\n### Interactive session {-}\n\nOn Tetralith you enter the *login node*, which is not intended for compute intensive tasks. You should therefore book a compute node, or in this case three cores:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('tetralith1$ interactive -A ',nscid,' -t 04:00:00 -n 3'))\n```\n\n::: {.callout-note}\nYour terminal prompt changed to something like `<nsc_username>@n424 $` (or another node name), which means that you are now running on one of the compute nodes. \n:::\n\n### UPPMAX singularity container {-}\n\nWe will use a singularity container (a virtual computer) that mimics the UPPMAX computing environment. Once you have started the singularity container your environment will look exactly as on UPPMAX, and the software used in this workshop will be available through the module system.\n\nUse this command to start the singularity container:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('n424$ singularity shell -B /proj/',nscid,'/users:/proj/',upid,'/nobackup /proj/',nscid,'/ngsintro.sif'))\n```\n\n::: {.callout-note}\nNote that your terminal prompt changed to something like `<nsc_username>@offline-uppmax$`. This means that you have moved into a \"virtual computer\" that mimics the UPPMAX environment. \n:::\n\nIn the singularity container type this to make modules based on Java to load properly:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('source /uppmax_init'))\n```\n\nTo close the singularity container later on just type `exit` in the terminal, but don't do that now.\n\n### Cluster workspace {-}\n\nWhile running the UPPMAX singularity container, create a workspace folder for this exercise and move into it: \n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('offline-uppmax$ mkdir /proj/',upid,'/nobackup/<nsc_username>/ngsworkflow\\n'))\ncat(paste0('offline-uppmax$ cd /proj/',upid,'/nobackup/<nsc_username>/ngsworkflow'))\n```\n\nThe folder you just created will be referred to as your *cluster workspace* throughout this workshop.  \n\nThe *cluster workspace* can be reached also from outside of the UPPMAX singularity container, in this folder on Tetralith:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('tetralith$ /proj/',nscid,'/users/<nsc_username>/ngsworkflow\\n'))\n```\n\nThis is the path you must use when downloading files to your *local workspace* later on.\n  \n**** \n\n::: {.callout-note}\n**Note:** The rest of the instructions assumes that you are running the UPPMAX singularity container from an interactive session on Tetralith, and that you are located in your *cluster workspace*, unless noted otherwise.\n:::\n\n### Symbolic links to data {-}\n\nThe raw data files are located in the [Data](#Data) folder described above. Instead of copying the files to your workspace you should create symbolic links (soft-links) to them. Soft-linking files and folders allows you to work with them as if they were in your current directory, but without multiplying them.  \n\nCreate a symbolic link to the reference genome in your workspace:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('offline-uppmax$ ln -s ',refdir,'/human_g1k_v37_chr2.fasta'))\n```\n\nDo the same with the fastq files:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00097_1.fq\\n')) \ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00097_2.fq\\n'))  \ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00100_1.fq\\n'))\ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00100_2.fq\\n'))\ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00101_1.fq\\n')) \ncat(paste0('offline-uppmax$ ln -s ',fastqdir,'/HG00101_2.fq\\n'))\n```\n\n### Accessing programs {#Accessingprograms -}\n\nWe will use several programs that are installed in the module system on UPPMAX. These modules must be loaded *every time* you start the singularity container.\n  \nFirst load the `bioinfo-tools` module:\n\n```bash\noffline-uppmax$ module load bioinfo-tools\n```\nThis makes it possible to load the individual programs:\n\n```bash\noffline-uppmax$ module load FastQC/0.11.8\noffline-uppmax$ module load bwa/0.7.17\noffline-uppmax$ module load samtools/1.10\noffline-uppmax$ module load GATK/4.1.4.1\n```\n\n::: {.callout-note}\nYou don't have to specify which versions of the tools to use, but is recommended to do so for reproducibility if you want to rerun the  exact same analyses later.\n:::\n\nWhen loading the module GATK/4.1.4.1 you may get a warning message about the fact that GATK commands have been updated since the previous version of GATK. This is fine and you don't have to do anything about it. \n    \n## Index the genome {-}\n\nTools that compare short reads with a large reference genome needs indexes of the reference genome to work efficiently. You therefore need to create index files for each tool. \n  \nGenerate BWA index files:\n\n```bash\noffline-uppmax$ bwa index -a bwtsw human_g1k_v37_chr2.fasta\n```\n\nCheck to see that several new files have been created using `ls -l`.\n  \nGenerate a samtools index: \n\n```bash\noffline-uppmax$ samtools faidx human_g1k_v37_chr2.fasta\n```\n\nCheck to see what file(s) were created using `ls -lrt`.\n\nGenerate a GATK sequence dictionary:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g CreateSequenceDictionary -R human_g1k_v37_chr2.fasta -O human_g1k_v37_chr2.dict\n```\n\nAgain, check what file(s) were created using `ls -lrt`. \n\n# Variant calling in one sample\n\nNow let's start the main part of the workshop, which will guide you through a basic variant calling workflow in one sample. The workflow consists of aligning the reads with [BWA](http://bio-bwa.sourceforge.net) and detecting variants with [HaplotypeCaller](https://gatk.broadinstitute.org/hc/en-us/articles/360037225632-HaplotypeCaller) as illustrated below. \n  \n![](assets/1_onesamplevc.png)\n\n## Aligning reads\n\n### BWA mem {#bwamem}\n\nIn the *Cluster workspace* you should now use `BWA mem` to align the reads to the reference genome.  \n \nAt the same time, you should add something called *read groups* to the reads in the fastq files. Read groups allow us to trace various technical features, such as which flow cell was used to generate the reads, and this is needed in order to perform variant calling with HaplotypeCaller. You are not expected to learn all the details of read groups here, but if you are interested in more information please read this article at [GATK-forum](https://gatk.broadinstitute.org/hc/en-us/articles/360035890671-Read-groups). The samples in this workshop come from the 1000 Genomes project, and we don't know how these reads were generated. Let's assume that each fastq file was generated from one library preparation (called *libraryx*), derived from one biological sample (called *HG00097*), that was run on one lane of a flow cell (called *lanex_flowcellx*) in the Illumina machine, and create a read group with id *readgroupx* that contains this information.   \n  \nThe output from `BWA` should be parsed to `samtools sort`, which sorts the sam file according to chromosome position and then converts the sam file to the binary bam format. This saves space since no intermediary sam file is created.  \n\nPlease use this command for all of this:\n\n```bash\noffline-uppmax$ bwa mem -R \"@RG\\\\tID:readgroupx\\\\tPU:lanex_flowcellx\\\\tSM:HG00097\\\\tLB:libraryx\\\\tPL:illumina\" -t 1 human_g1k_v37_chr2.fasta HG00097_1.fq HG00097_2.fq | samtools sort > HG00097.bam\n```\n\nWhere `-t 1` is the number of threads, which should be equal to the number of cores you booked. If you would have analysed the entire genome more threads would have been necessary.  \n\nYou have to use a file redirect `>` for the output, otherwise it will be written to stdout (your screen).  \n\nPlease check that the expected output file was generated and that it has content using `ls -lrt`. \n\nNext you need to index the output bam file so that programs can randomly access the sorted data without reading the whole file. This command creates an index file with the same name as the input bam file, except with a .bai extension:  \n\n```bash\noffline-uppmax$ samtools index HG00097.bam\n```\n\nPlease check what output file was generated this time. \n  \n### Check bam with samtools\n\nThe bam file is binary so we cannot read it, but we can view it with `samtools view`. The header section of the bam file can be viewed separately with the `-H` flag:\n\n```bash\noffline-uppmax$ samtools view -H HG00097.bam \n```\n\nTo look at the reads in the bam file just use `samtools view` without the `-H`. This will display the entire bam file which is quite large, so if you just want to look at the first 5 lines (for example) you can combine `samtools view` with `head`:\n\n```bash\noffline-uppmax$ samtools view HG00097.bam | head -n 5 \n```\n\nFor help with interpreting the bam file, please look at the sam/bam format definition at [Sequence Alignment/Map Format Specification](https://samtools.github.io/hts-specs/SAMv1.pdf).  \n  \n### Questions  \n\n1. What does \"SO:coordinate\" in the \"@HD\" tag on the first line of the bam file mean?    \n2. What does \"SN:2\" and \"LN:243199373\" in the \"@SQ tag mean? \n3. What is encoded in the @RG tag?  \n4. What is the leftmost mapping position of the first read in the bamfile? \n  \n### Check bam in IGV\n\n**Install IGV**  \n\nIntegrated Genomics Viewer (IGV) provides an interactive visualisation of the reads in a bam file. Here we will show you how to run IGV on your laptop. If you have not used IGV on your laptop before, then go to the IGV [download page](https://software.broadinstitute.org/software/igv/download), and follow the instructions to download it. It will prompt you to fill in some information and agree to license. Launch the viewer through web start. The 1.2 Gb version should be sufficient for our data.\n  \n**Download the bam file** \n\nOpen a new terminal window on your laptop and navigate to your [local workspace](#preparelaptop), **but do not log in to NSC**. Download the .bam and .bam.bai files you just generated with this command:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0('scp <nsc_username>@tetralith.nsc.uu.se:/proj/',nscid,'/users/<nsc_username>/ngsworkflow/HG00097.bam* .'))\n```\n\nCheck that the files are now present in your *local workspace* using `ls -lrt`. \n  \n**Look at the bam file in IGV**  \n\n- In `IGV`, go to the popup menu in the upper left and set it to `Human hg19`.  \n- In the `Tools` menu, select `Run igvtools`. Choose the command `Count` and then use the `Browse` button next to the `Input File` line to select the bam file (not the bai) that you just downloaded. It will autofill the output file. Hit the `Run` button. This generates a .tdf file that allows you to see the coverage value for our bam file even at zoomed out views. `Close` the igvtools window.  \n- In the `File` menu, select `Load from File` and select your BAMs (not the .bai or the .tdf), which should appear in the tracks window. You will have to zoom in before you can see any reads. You can either select a region by click and drag, or by typing a region or a gene name in the text box at the top. Remember that we have data for the region chr2:136545000-136617000.\n  \n### Questions  \n\n5. What is the read length?  \n6. How can you estimate the coverage at a specific position in IGV? \n7. Which RefSeq Genes are located within the region chr2:136545000-136617000?\n  \n## Variant Calling\n\n### HaplotypeCaller {#haplotypecaller}\n\nNow we will detect short variants in the bam file using GATK's `HaplotypeCaller`. Go to your *Cluster workspace* and run:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -I HG00097.bam -O HG00097.vcf \n```\n\nCheck what new files were generated with `ls -lrt`.  \n  \n### Explore the vcf file\n\nNow you have your first vcf file containing the raw variants in the region chr2:136545000-136617000 in sample HG00097. Please look at the vcf file with `less` and try to understand its structure.  \n  \nVCF files contains meta-information lines starting with *##*, a header line starting with *#CHROM*, and then data lines each containing information about one variant position in the genome. The header line defines the columns of the data lines, and to view the header line you can type this command:  \n\n```bash\noffline-uppmax$ grep '#CHROM' HG00097.vcf\n```\n\nThe meta-information lines starting with *##INFO* defines how the data in the *INFO* column is encoded, and the meta-information lines starting with *##FORMAT* defines how the data in the *FORMAT* column is encoded. To view the meta-information lines describing the *INFO* column use:\n\n```bash\noffline-uppmax$ grep '##INFO' HG00097.vcf\n```\n\nTo view the meta-information lines describing the *FORMAT* column use: \n\n```bash\noffline-uppmax$ grep '##FORMAT' HG00097.vcf\n```\n\nNow lets look at the details of one specific genetic variant at position 2:136545844:\n\n```bash\noffline-uppmax$ grep '136545844' HG00097.vcf\n```\n\nFor more detailed information about vcf files please have a look at [The Variant Call Format specification](https://samtools.github.io/hts-specs/VCFv4.2.pdf).\n  \n### Questions\n\n8. What column of the VCF file contains genotype information for the sample HG00097?\n9. What does *GT* in the *FORMAT* column of the data lines mean?\n10. What genotype does the sample HG00097 have at position 2:136545844?\n11. What does *AD* in the *FORMAT* column of the data lines mean? \n12. What are the allelic depths for the reference and alternative alles in sample HG00097 at position 2:136545844?\n13. How many genetic variants was detected in the sample? The linux command `grep -v \"#\" HG00097.vcf | wc -l ` extracts all lines in HG00097.vcf that *don't* start with \"#\", and counts these lines.  \n\n### Check vcf in IGV {#vcfinigv}\n\nDownload the vcf file and its index to the *local workspace* on your laptop, just like you did with the bam file and its index earlier. Open a new terminal window on your laptop and navigate to your local workspace, **but do not log in to NSC**. Download the files that you just generated with:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\", class.source=\"workLocally\"}\ncat(paste0('scp <nsc_username>@tetralith.nsc.uu.se:/proj/',nscid,'/users/<nsc_username>/ngsworkflow/HG00097.vcf* .'))\n```\n\nPlease replace `<nsc_nsc_username>` with your NSC user name.  \nNote that the * in the end of the file name means that you will download all files that start with *HG00097.vcf*, so you will also download the vcf index.  \nCheck that the files were properly downloaded to your *local workspace* using `ls -lrt`. \n\nIn `IGV`, in the `File` menu, select `Load from File` and select your vcf file (not the .idx file) and the bam file (not the .bai file) that you downloaded earlier. The vcf and bam files should appear in the tracks window. You will now see all the variants called in HG00097. You can view all variants in the *LCT* gene by typing the gene name in the search box, and you can look specifically at the variant at position chr2:136545844 by typing that position in the search box.  \n  \n### Questions  \n\n14. Hover the mouse over the upper row of the vcf track. What is the reference and alternative alleles of the variant at position chr2:136545844? \n15. Hover the mouse over the lower row of the vcf track and look under \"Genotype Information\". What genotype does HG00097 have at position chr2:136545844? Is this the same as you found by looking directly in the vcf file in question 10?\n16. Look in the bam track and count the number of reads that have \"T\" and \"C\", respectively,  at position chr2:136545844. How is this information captured under \"Genotype Attributes\"? (Again, hoover the mouse over the lower row of the vcf track.)\n \n# Variant calling in cohort {#jointvc}\n\nIf you have time, you can now try joint variant calling in all three samples. Each sample has to be processed with `BWA mem` as above, and then with `HaplotypeCaller` with the flag `-ERC` to generate one g.vcf file per sample. The individual g.vcf files should subsequently be combined with GATK's `CombineGVCFs`, and translated into vcf format with GATK's `GenotypeGVCFs`. The workflow below shows how the three samples should be processed and combined.  \n  \n![](assets/2_jointvc.png)\n\n\nYou can run the commands one by one in the terminal as you did before. We have also made intermediary files available in case you don't have time to complete all steps, please see links under each analysis step. \n\n::: {.callout-note}\n**Optional**: If you are interested in programming and have time, you can also try to write a simple SBATCH script and run all steps automatically. Please check out the [SBATCH script](#sbatchscript) section below if you would like to try this.\n:::\n\n## BWA mem \n\nRun `BWA mem` for all three samples in the data set. `BWA mem` should be run exactly [as above](#bwamem) but with the new sample names. Please note that you also need to adjust the SM field in the read group so that it matches the new sample name, otherwise the [joint genotyping step](#jointgenotyping) will not work properly.  \n  \nIf you run out of time, please click below to get paths to precomputed bam files. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0(bamdir,'/HG00097.bam\\n')) \ncat(paste0(bamdir,'/HG00100.bam\\n')) \ncat(paste0(bamdir,'/HG00101.bam\\n')) \n```\n \n## Generate g.vcf files {#generategvcf}\n\n`HaplotypeCaller` should also be run for all three samples, but this time the output for each sample needs to be in g.vcf format. This is accomplished with a small change in the `HaploteypCaller` command: \n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -ERC GVCF -I <sample.bam> -O <sample>.g.vcf \n```\n\nPlease replace <sample> with the real sample names.\n   \nIf you run out of time, please click below to get paths to the precomputed g.vcf files.\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0(vcfdir,'/HG00097.g.vcf\\n')) \ncat(paste0(vcfdir,'/HG00100.g.vcf\\n')) \ncat(paste0(vcfdir,'/HG00101.g.vcf\\n')) \n```\n  \n## Joint genotyping {#jointgenotyping}\n\nOnce you have the g.vcf files for all samples you should perform joint genotype calling. To do this you first need to combine all individual .g.vcf files to one file using `CombineGVCFs`:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g CombineGVCFs -R human_g1k_v37_chr2.fasta -V <sample1>.g.vcf -V <sample2>.g.vcf -V <sample3>.g.vcf -O cohort.g.vcf\n```\n\nPlease replace `<sample1>`, `<sample2>`, `<sample3>` with the real sample names.\n  \nThen run GATK's `GenoteypeGVC` to generate a vcf file:\n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g GenotypeGVCFs -R human_g1k_v37_chr2.fasta -V cohort.g.vcf -O cohort.vcf\n```\n\nIf you run out of time, please click below to get paths to the precomputed cohort.g.vcf and cohort.vcf files.\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0(vcfdir,'/cohort.g.vcf\\n')) \ncat(paste0(vcfdir,'/cohort.vcf\\n')) \n```\n\n### Questions {#jointvariantcallingquestions}\n\n17. How many data lines do the cohort.g.vcf file have? You can use the Linux command `grep -v \"#\" cohort.g.vcf` to extract all lines in \"cohort.g.vcf\" that don't start with \"#\", then `|`, and then `wc -l` to count those lines.  \n18. How many data lines do the cohort.vcf file have?  \n19. Explain the difference in number of data lines.  \n20. Look at the header line of the cohort.vcf file. What columns does it have? \n21. What is encoded in the last three columns of the data lines?\n  \n## SBATCH script {#sbatchscript}\n\n::: {.callout-note}\n\n## Optional\n\nThis section is only for those of you who want to try to run all steps automatically in bash scripts. \nBelow is a skeleton script that can be used as a template. Please modify it to run all the steps in part two of this workshop. You might find it helpful to try each step for one sample in the interactive terminal, so that you know that a particular command is working, before you incorporate it in the script.  \n\n```bash\n#!/bin/bash\nmodule load bioinfo-tools\nmodule load bwa/0.7.17\nmodule load samtools/1.10\nmodule load GATK/4.1.4.1\n## loop through the samples:\nfor sample in HG00097 HG00100 HG00101;\ndo\n  echo \"Now analyzing: \"$sample\n  #Fill in the code for running bwa-mem for each sample here\n  #Fill in the code for samtools index for each sample here \n  #Fill in the code for HaplotypeCaller for each sample here\ndone\n#Fill in the code for CombineGVCFs for all samples here\n#Fill in the code for GenotypeGVCFs here\n```\n\nPlease save the sbatch script in your cluster folder and call it \"joint_genotyping.sh\" or similar. Make the script executable by this command:\n\n```bash\nchmod u+x joint_genotyping.sh\n```\n\nUse this command to run the script in the singularity container:\n\n```bash\n./joint_genotyping.sh\n```\n\nIf you would like more help with creating the bash script, please look at our example solution:\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('#!/bin/bash\n\nmodule load bioinfo-tools\nmodule load bwa/0.7.17\nmodule load samtools/1.10\nmodule load GATK/4.1.4.1\n\nfor sample in HG00097 HG00100 HG00101;\ndo\n  echo \"Now analyzing: \"$sample\n  bwa mem -R \"@RG\\\\tID:readgroupx\\\\tPU:flowcellx_lanex\\\\tSM:\"$sample\"\\\\tLB:libraryx\\\\tPL:illumina\" -t 1 human_g1k_v37_chr2.fasta $sample\"_1.fq\" $sample\"_2.fq\" | samtools sort > $sample\".bam\"\n  samtools index $sample\".bam\"\n  gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -ERC GVCF -I $sample\".bam\" -O $sample\".g.vcf\"\ndone\ngatk --java-options -Xmx7g CombineGVCFs -R human_g1k_v37_chr2.fasta -V HG00097.g.vcf -V HG00100.g.vcf -V HG00101.g.vcf -O cohort.g.vcf\ngatk --java-options -Xmx7g GenotypeGVCFs -R human_g1k_v37_chr2.fasta -V cohort.g.vcf -O cohort.vcf'\n))\n```  \n\nPlease answer the [questions ](#jointvariantcallingquestions) above.\n\n:::\n\n## Check combined vcf file in IGV\n\nDownload the file cohort.vcf and its index, as well as HG00100.bam and HG00101.bam and their indexes to your *local workspace* as described [above]{#downloaddata}. Then open cohort.vcf, HG00097.bam, HG00100.bam and HG00101.bam in IGV as described [above]{#vcfinigv}. This time lets look at the variant rs4988235, located at position chr2:136608646 in the HG19 reference genome, that has been shown to lead to lactose persistence. \n  \n### Questions\n\n22. What is the reference and alternative alleles at chr2:136608646?\n23. What genotype do the three samples have at chr2:136608646? Note how genotypes are color coded in IGV.\n24. Should any of the individuals avoid drinking milk?   \n25. Now compare the data shown in IGV with the data in the VCF file. Extract the row for the chr2:136608646 variant in the cohort.vcf file, for example using `grep '136608646' cohort.vcf`. What columns of the vcf file contain the information shown in the upper part of the vcf track in IGV?\n26. What columns of the vcf file contain the information shown in the lower part of the vcf track?\n27. Zoom out so that you can see the *MCM6* and *LCT* genes. Is the variant at chr2:136608646 locate within the LCT gene?  \nIf you are interested in how this variant affects lactose tolerance please read the article by Mattar et al presented [above](#Genomicregion), or in [OMIM](https://www.omim.org/entry/601806#0001).\n\n# GATK's best practices\n\nThe third part of this workshop will take you through additional refinement steps that are recommended in [GATKs best practices for germline short variant discovery](https://gatk.broadinstitute.org/hc/en-us/articles/360035535932-Germline-short-variant-discovery-SNPs-Indels-), illustrated in the flowchart below. You can either run the steps command by command in your reserved node, or using a similar script as described above. \n\n![](assets/3_best_practise.png){width=80%}\n  \n## BWA mem \n\nRun `BWA mem` for all three samples in the data set. `BWA mem` should be run exactly [as above](#bwamem) but with the new sample names. Please note that you also need to adjust the SM field in the read group so that it matches the new sample name. \n  \n## Mark Duplicates\n\nSometimes the same DNA fragment is sequenced multiple times, which leads to multiple reads from the same fragment in the fastq file. This can occur due to PCR amplification in the library preparation, or if one read cluster is incorrectly detected as multiple clusters by the sequencing instrument. \nIf a duplicated read contains a genetic variant, the ratio of the two alleles might be obscured, which can lead to incorrect genotyping. It is therefore recommended (in most cases) to mark duplicate reads so that they are counted as one during genotyping. \n  \nPlease read about Picard's `MarkDuplicates` [here](https://gatk.broadinstitute.org/hc/en-us/articles/360037225972-MarkDuplicates-Picard-). Picard's MarkDuplicates has recently been incorporated into the GATK suite, but the usage example in GATKs documentation still describes how to call it via the stand alone Picard program. A usage example for the version of MarkDuplicates that is incorporated in GATK is (with this you don't have to load the Picard module): \n\n```bash\noffline-uppmax$ gatk --java-options -Xmx7g MarkDuplicates \\\n      -I input.bam \\\n      -O marked_duplicates.bam \\\n      -M marked_dup_metrics.txt\n```\n\nIf you would like more help you can sneak peek at our example solution for HG00097 below. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g MarkDuplicates -I HG00097.bam -O HG00097.md.bam -M HG00097_mdmetrics.txt'))\n```\n  \n## Recalibrate Base Quality Scores\n\nAnother source of error is systematic biases in the assignment of base quality scores by the sequencing instrument. This can be corrected by GATK's [Base Quality Score Recalibration](https://gatk.broadinstitute.org/hc/en-us/articles/360035890531-Base-Quality-Score-Recalibration-BQSR-). \nIn short, you first use [BaseRecalibrator](https://gatk.broadinstitute.org/hc/en-us/articles/360037593511-BaseRecalibrator) to build a recalibration model, and then [ApplyBQSR](https://gatk.broadinstitute.org/hc/en-us/articles/360037225212-ApplyBQSR) to recalibrate the base qualities in your bam file.  \n`BaseRecalibrator` requires a file with known SNPs as input. This file is available in the data folder on UPPMAX:\n\n```{r,echo=FALSE,comment=\"\",class.output=\"bash\"}\ncat(paste0(refdir,'/1000G_phase1.snps.high_confidence.b37.chr2.vcf'))\n```\n\nPlease use GATK's documentation to recalibrate the base quality scores in your data. If you would like more help you can sneak peek at our example solution for HG00097 below. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g BaseRecalibrator -R human_g1k_v37_chr2.fasta -I HG00097.md.bam> --known-sites ',refdir,'/1000G_phase1.snps.high_confidence.b37.chr2.vcf -O HG00097.recal.table\\n'))\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g ApplyBQSR -R human_g1k_v37_chr2.fasta -I HG00097.md.bam --bqsr-recal-file HG00097.recal.table -O HG00097.recal.bam'))\n```\n\n## Generate g.vcf files\n\n`HaplotypeCaller` should also be run for all three samples, and the output should be in g.vcf exactly as described [above](#generategvcf). This time use recalibrated bam files as input. \n\n## Joint genotyping\n\nOnce you have the g.vcf files for all samples you should perform joint genotype calling. This should be done with the commands `CombineGVCFs` and `GenotypeGVCFs` exactly as described  [above](#jointgenotyping), but you should use the g.vcf files generated from the recalibrated bam files as input.\n\n## Variant Filtering\n\nHaplotypeCaller is designed to be very sensitive, which is good because it minimises the chance of missing real variants. However, it means that the number of false positives can be quite large, so we need to filter the raw callset. GATK offers two ways to filter variants:  \n\n1. The variant quality score recalibration (VQSR) method uses machine learning to identify variants that are likely to be real. This is the best method if you have a lot of data, for example one whole genome sequence sample or several whole exome samples. \n2. If you have less data you can use hard filters as described [here](https://gatk.broadinstitute.org/hc/en-us/articles/360035531112?id=2806#2). \n  \nSince we have very little data we will use hard filters. The parameters are slightly different for SNVs and INDELs, so you need to first select all SNVs using [SelectVariants](https://gatk.broadinstitute.org/hc/en-us/articles/360037225432-SelectVariants) and filter them using [VariantFiltration](https://gatk.broadinstitute.org/hc/en-us/articles/360037226192-VariantFiltration) with the parameters suggested for SNVs. Then select all INDELs and filter them with the parameters suggested for INDELs. Finally merge the SNVs and INDELs to get all variants in one file using [MergeVCFs](https://gatk.broadinstitute.org/hc/en-us/articles/360037226612-MergeVcfs-Picard-). If you would like more help you can sneak peek at our example solution for HG00097 below.  \n\nFilter SNVs:\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g SelectVariants \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.vcf \\\n  --select-type-to-include SNP \\\n  -O cohort.snvs.vcf\n  \noffline-uppmax$ gatk --java-options -Xmx7g VariantFiltration \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.snvs.vcf \\\n  -O cohort.snvs.filtered.vcf \\\n  --filter-name QDfilter --filter-expression \"QD < 2.0\"  \\\n  --filter-name MQfilter --filter-expression \"MQ < 40.0\"  \\\n  --filter-name FSfilter --filter-expression \"FS > 60.0\"'))\n```\n\nFilter INDELs: \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g SelectVariants \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.vcf \\\n  --select-type-to-include INDEL \\\n  -o cohort.indels.vcf\n\noffline-uppmax$ gatk --java-options -Xmx7g VariantFiltration \\\n  -R human_g1k_v37_chr2.fasta \\\n  -V cohort.indels.vcf \\\n  -O cohort.indels.filtered.vcf \\\n  --filter-name QDfilter --filter-expression \"QD < 2.0\" \\\n  --filter-name FSfilter --filter-expression \"FS > 200.0\"'))\n```\n\nMerge filtered SNVs and INDELs: \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('offline-uppmax$ gatk --java-options -Xmx7g MergeVcfs -I cohort.snvs.filtered.vcf -I cohort.indels.filtered.vcf -O cohort.filtered.vcf'))\n```\n  \nOpen your filtered vcf with `less` and page through it. It still has all the variant lines, but the FILTER column that was blank before is now filled in, with PASS or a list of the filters it failed. Note also that the filters that were run are described in the header section.\n\n## Precomputed files\n\nIf you run out of time, please click below to get the path to precomputed bam and vcf files for the GATK's best practices section.\n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('Path to intermediary and final bam files: ',bpbamdir,'\\n'))\ncat(paste0('Path to intermediary and final vcf files: ',bpvcfdir,'\\n'))\n```\n\n## SBATCH script {#bpscript}\n\nWe recommend you to incorporate the new steps into an SBATCH script similar to the one you created above for [joint variant calling](#sbatchscript). Please try to complete the script for GATK's best practices workflow. If you run out of time you can sneak peek at our example solution below. \n\n```{r,accordion=TRUE,chunk.title=TRUE,echo=FALSE,comment=\"\",class.output=\"sh\"}\ncat(paste0('#!/bin/bash\n\n## load modules\nmodule load bioinfo-tools\nmodule load bwa/0.7.17\nmodule load samtools/1.10\nmodule load GATK/4.1.4.1\n\n# define path to reference genome\nref=\"/sw/courses/ngsintro/reseq/data/ref\"\n\n# make symbolic links\nln -s /sw/courses/ngsintro/reseq/data/ref/human_g1k_v37_chr2.fasta\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00097_1.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00097_2.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00100_1.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00100_2.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00101_1.fq\nln -s /sw/courses/ngsintro/reseq/data/fastq/HG00101_2.fq\n\n# index reference genome\nbwa index -a bwtsw human_g1k_v37_chr2.fasta\nsamtools faidx human_g1k_v37_chr2.fasta\ngatk --java-options -Xmx7g CreateSequenceDictionary -R human_g1k_v37_chr2.fasta -O human_g1k_v37_chr2.dict\n\n## loop through the samples:\nfor sample in HG00097 HG00100 HG00101;\ndo\n  echo \"Now analyzing: ${sample}\"\n  # map the reads\n  bwa mem -R \"@RG\\\\tID:readgroupx\\\\tPU:flowcellx_lanex\\\\tSM:\"$sample\"\\\\tLB:libraryx\\\\tPL:illumina\" -t 1 human_g1k_v37_chr2.fasta $sample\"_1.fq\" $sample\"_2.fq\" | samtools sort > $sample\".bam\"\n  samtools index $sample\".bam\"\n  # mark duplicates\n  gatk --java-options -Xmx7g MarkDuplicates -I $sample\".bam\" -O $sample\".md.bam\" -M $sample\"_mdmetrics.txt\"\n  # base quality score recalibration\n  gatk --java-options -Xmx7g BaseRecalibrator -R human_g1k_v37_chr2.fasta -I $sample\".md.bam\" --known-sites $ref\"/1000G_phase1.snps.high_confidence.b37.chr2.vcf\" -O $sample\".recal.table\"\n  gatk --java-options -Xmx7g ApplyBQSR -R human_g1k_v37_chr2.fasta -I $sample\".md.bam\" --bqsr-recal-file $sample\".recal.table\" -O $sample\".recal.bam\"\n  # haplotypeCaller in -ERC mode\n  gatk --java-options -Xmx7g HaplotypeCaller -R human_g1k_v37_chr2.fasta -ERC GVCF -I $sample\".bam\" -O $sample\".g.vcf\" \ndone\n\n# joint genotyping\ngatk --java-options -Xmx7g CombineGVCFs -R human_g1k_v37_chr2.fasta -V HG00097.g.vcf -V HG00100.g.vcf -V HG00101.g.vcf -O cohort.g.vcf\ngatk --java-options -Xmx7g GenotypeGVCFs -R human_g1k_v37_chr2.fasta -V cohort.g.vcf -O cohort.vcf\n# variant filtration SNPs\ngatk --java-options -Xmx7g SelectVariants -R human_g1k_v37_chr2.fasta -V cohort.vcf --select-type-to-include SNP -O cohort.snvs.vcf\ngatk --java-options -Xmx7g VariantFiltration -R human_g1k_v37_chr2.fasta -V cohort.snvs.vcf -O cohort.snvs.filtered.vcf --filter-name QDfilter --filter-expression \"QD < 2.0\" --filter-name MQfilter --filter-expression \"MQ < 40.0\"  --filter-name FSfilter --filter-expression \"FS > 60.0\"\n# variant filtration indels\ngatk --java-options -Xmx7g SelectVariants -R human_g1k_v37_chr2.fasta -V cohort.vcf --select-type-to-include INDEL -O cohort.indels.vcf\ngatk --java-options -Xmx7g VariantFiltration -R human_g1k_v37_chr2.fasta -V cohort.indels.vcf -O cohort.indels.filtered.vcf --filter-name QDfilter --filter-expression \"QD < 2.0\" --filter-name FSfilter --filter-expression \"FS > 200.0\"\n# merge filtered SNPs and indels\ngatk --java-options -Xmx7g MergeVcfs -I cohort.snvs.filtered.vcf -I cohort.indels.filtered.vcf -O cohort.filtered.vcf'\n))\n```  \n  \n## Questions  \n\n28. How many variants are present in the cohort.filtered.vcf file?  \n29. How many variants have passed the filters?  \n30. Look at the variants that did not pass the filters using `grep -v 'PASS' cohort.filtered.vcf`. Try to understand why these variants didn't pass the filter.\n\n# Clean up {-}\n\nWhen the analysis is done and you are sure that you have the desired output, it is a good practice to remove intermediary files that are no longer needed. This will save disk space, and will be a crucial part of the routines when you work with your own data. Please think about which files you need to keep if you would like to go back and look at this lab later on. Remove the other files.\n  \n# Answers {-}\n\nWhen you have finished the exercise, please have a look at this document with [answers to all questions](lab_vc_answers.pdf), and compare them with your answers. \n\n# Additional information {-}\n\n* Here is a technical documentation of [Illumina Quality Scores](https://www.illumina.com/documents/products/technotes/technote_understanding_quality_scores.pdf)\n* Tools used or referenced \n  * [BWA](http://bio-bwa.sourceforge.net/bwa.shtml)\n  * [FastQC](https://www.bioinformatics.babraham.ac.uk/projects/fastqc/)\n  * [MultiQC](http://multiqc.info/)\n  * [Picard](https://broadinstitute.github.io/picard/command-line-overview.html)\n  * [GATK](https://software.broadinstitute.org/gatk/)\n  * [samtools](http://www.htslib.org/)\n\n**Thanks for today!**\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"kable","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"left","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":false,"wrap":"none","default-image-extension":"png","to":"html","filters":["../../assets/custom.lua","reveal-header","lightbox"],"include-in-header":["../../assets/fonts/head.html"],"toc":true,"toc-depth":4,"number-sections":true,"output-file":"lab_vc_tetralith.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","bibliography":["../../references.bib"],"csl":"../../apa.csl","knitr":{"opts_chunk":{"results":"hold"}},"uppmax_project":"snic2023-xx-xxxx","nsc_project":"snic2023-xx-xxxx","uppmax_res_1":"snic2023-xx-xxxx_1","uppmax_res_2":"snic2023-xx-xxxx_2","uppmax_res_3":"snic2023-xx-xxxx_3","uppmax_res_4":"snic2023-xx-xxxx_4","uppmax_res_5":"snic2023-xx-xxxx_5","location":"uppsala","assistants":["AJ: Anna Johansson","BV: Bjrn Viklund","DA: Dag Ahren","FB: Franziska Bonath","JH: Jason Hill","JB: Joakim Bygdell","JA: Juliana Assis","KL: Katarina Lejonlid","KB: Kristina Benevides","LK: Linda Khn","LV: Louella Vasquez","MD: Martin Dahl","MG: Maxime Garcia","ML: Malin Larsson","MM: Markus Mayrhofer","NN: Nina Norgren","OVP: Olga Vinnere Pettersson","PA: Prasoon Agarwal","PP: Paul Pyl","RF: Roy Francis","VVH: Vincent van Hoef","SD: Sebastian DiLorenzo"],"schedule_message":"Coffee breaks are planned for approximately 10:00 and 14:30 every day.","colors":{"primary":"#95b540","secondary":"#E9F2D1"},"packages":{"packages_cran_student":["BiocManager","remotes","dplyr","ggplot2","pheatmap","stringr","tidyr"],"packages_bioc_student":["DESeq2","edgeR","goseq","GO.db","org.Mm.eg.db","reactome.db"],"packages_github_student":null,"packages_cran_repo":["bookdown","captioner","here","htmlTable","knitr","leaflet","lubridate","markdown","pagedown","yaml"],"packages_bioc_repo":null,"packages_github_repo":null},"quarto-required":">=1.2.2","theme":"../../assets/css/custom.scss","smooth-scroll":true,"toc-location":"right","number-depth":4,"code-copy":true,"title-block-banner":"#E9F2D1","callout-icon":false,"date":"last-modified","date-format":"DD-MMM-YYYY","lightbox":{"match":"auto"},"title":"Variant Calling Workflow","subtitle":"From reads to short variants","description":"On Tetralith at NSC","author":"Malin Larsson"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html","revealjs"]}